<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>无人机通信巡检系统</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="" name="description"/>
    <meta content="" name="author"/>

    <!-- BEGIN GLOBAL MANDATORY STYLES -->

    <link href="media/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="media/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" />
    <link href="media/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="media/css/style.css" rel="stylesheet" type="text/css" />
    <link href="media/css/style-responsive.css" rel="stylesheet" type="text/css" />
    <link href="media/css/light.css" rel="stylesheet" type="text/css"/>
    <link rel="icon" type="image/png" href="${s.base}/i/ico.png" sizes="16x16">

    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>
    <script src="http://cache.amap.com/lbs/static/es5.min.js"></script>
    <script src="http://webapi.amap.com/maps?v=1.4.6&key=82f9e75505b649be9ab81a45ae34aa14"></script>
    <script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
    <link rel="stylesheet" href="${s.base}/res/css/common.css">
</head>
<body class="page-header-fixed">
<#include "common/header.html" />
<div class="page-container">
    <#include "common/nav.html" />
    <!-- BEGIN PAGE -->

    <div class="page-content">
        <!-- BEGIN PAGE CONTAINER-->
        <div class="container-fluid">

            <!-- END BEGIN STYLE CUSTOMIZER -->

            <!-- BEGIN PAGE TITLE & BREADCRUMB-->

            <!--  下面这块内容是在页面写死的  -->
            <h4 class="page-title">设施管理
                <small>无人机查看</small>
            </h4>

            <ul class="breadcrumb">
                <li>
                    <i class="icon-home"></i>
                    <a href="#">设施管理</a>
                    <i class="icon-angle-right"></i>
                </li>
                <li><a href="${s.base}/uavList.action">无人机查看</a></li>
            </ul>

            <!-- END PAGE TITLE & BREADCRUMB-->
        </div>
        <!-- END PAGE HEADER-->
        <div id="dashboard"  style="position:relative;">

            <div id="container" ></div>
            <div class="portlet box yellow" id="panel" style="margin: 0;">
                <div class="portlet-title">
                    <div class="caption"><i class="icon-plane"></i>无人机查看</div>
                    <div class="tools">
                        <a href="" class="collapse"></a>
                    </div>
                </div>
                <div class="portlet-body" >
                    <div class="tabbable portlet-tabs">
                        <div >
                            <div id="planeSelect" class="control-group">
                                <p>
                                    <input type="checkbox" name="optionsRadiosinline" id="optionsRadios0" value="0"  onclick="showplane(0)"><span style="color: #2114F4;">飞行中</span>
                                    <input type="checkbox" name="optionsRadiosinline" id="optionsRadios1" value="1"  onclick="showplane(1)" ><span style="color: #8e44ad">已入库</span>
                                    <input type="checkbox" name="optionsRadiosinline" id="optionsRadios2" value="2"  onclick="showplane(2)"><span style="color: #27ae60">待放飞</span>
                                    <input type="checkbox" name="optionsRadiosinline" id="optionsRadios3" value="3"  onclick="showplane(3)"><span style="color: #e74c3c">故障中</span>
                                </p>
                            </div>
                            <ul id="my-list"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- UI组件库 1.0 -->

            <!-- UI组件库 1.0 -->
            <script src="//webapi.amap.com/ui/1.0/main.js?v=1.0.11"></script>
            <script type="text/javascript">

                data = ${planelist};
                //创建地图
                var map = new AMap.Map('container', {
                    zoom: 15,
                    center: [107.79876,23.06781], //中心点坐标
                });
                map.plugin(["AMap.Scale"],function(){    //加载比例尺插件
                    var scale = new AMap.Scale({
                        visible: true,
                        position:'LB',
                    });
                    map.addControl(scale);
                    scale.show();
                });

                if(location.href.indexOf('&guide=1')!==-1){
                    map.setStatus({scrollWheel:false})
                }
                AMapUI.loadUI(['control/BasicControl'], function(BasicControl) {

                    var layerCtrl1 = new BasicControl.LayerSwitcher({
                        position: 'RB',
                    });
                    map.addControl(layerCtrl1);
                });

                var infoWindow = new AMap.InfoWindow({
                    isCustom: true,
                    offset: new AMap.Pixel(20, -25)
                });
                var colors = ['#0cc2f2', '#4fd2b1', '#90e36f', '#ffe700', '#ff9e00', '#ff6700', '#ff1800',];
                var statuscode = [0, 1, 2, 3];
                var Statusdec = ['飞行中', '已入库', '待放飞', '故障'];
                var Imgsrc = ['fly-32.png', 'store-32.png', 'wait-32.png', 'warn-32.png'];
                var markersize = data.length;
                var markerlist = {};
                for (var m = 0; m < 4; m++) {
                    markerlist[statuscode[m]] = new Array();
                }


                for (var i = 0; i < markersize; i++) {
                    var statusDec = Statusdec[data[i].status];
                    var imgsrc = 'i/' + Imgsrc[data[i].status];

                    var markeritem = new AMap.Marker({
                        //map: map,
                        position: data[i].position,
                        icon: new AMap.Icon({
                            size: new AMap.Size(32, 32), //图标大小
                            image: imgsrc,
                            offset: new AMap.Pixel(-16,-16) // 相对于基点的偏移位置
                        }),

                    });

                    //实例化信息窗体
                    var title = '无人机名称:<span>' + data[i].name + '</span>';
                    var content = [];
                    content.push("状态：" + statusDec);
                    content.push("描述：" + data[i].description);
                    content.push("创建时间：" + data[i].updatetime);

                    markeritem.content = createInfoWindow(title, content.join("<br/>"));
                    markeritem.on('click', markerClick);

                    markerlist[data[i].status].push(markeritem);
                }

                function markerClick(e) {
                    infoWindow.setContent(e.target.content);
                    infoWindow.open(map, e.target.getPosition());
                }


                //选中无人机类型进行显示,并且展示相关列表
                function showplane(index) {

                    var disRouteCheckbox = document.getElementById("optionsRadios" + index);
                    if (disRouteCheckbox.checked == true) {
                        map.add(markerlist[statuscode[index]]);

                    } else {
                        map.remove(markerlist[statuscode[index]]);
                    }
                    document.getElementById("my-list").innerHTML = "";
                    var flaglist = [];
                    var innHTML = "";
                    for (var i = 0; i < 4; i++) {
                        var checkfg = document.getElementById("optionsRadios" + i);
                        if (checkfg.checked == true) {
                            flaglist.push(i);
                        }
                    }
                    for (var j = 0; j < data.length; j++) {
                        if (flaglist.indexOf(data[j].status) >= 0) {
                            var str = '<li class="poibox" onclick="showPlan(' + 'this,' + data[j].position + ')">无人机名称：'
                                    + data[j].name + '&nbsp;&nbsp;状态：' + Statusdec[data[j].status]
                                    + '<br>更新时间：' + data[j].updatetime
                                    + '<br>描述：' + data[j].description
                                    + '<br>SIM卡1：' + data[j].phoneone
                                    + '<br>SIM卡2：' + data[j].phonetwo
                                    + '</li>';

                            innHTML = innHTML + str;
                        }
                    }
                    document.getElementById("my-list").innerHTML = innHTML;
                }

                var pointSimplifierIns = null;
                function showPlan(e, positionX, positionY) {

                    var posi = [positionX, positionY];
                    var lilist = document.getElementById('my-list')
                    var eles = lilist.getElementsByTagName('li');

                    for(var i=0;i<eles.length;i++){
                        eles[i].className = 'poibox';
                    }
                    e.className ='poibox selected';

                    //添加闪烁点效果
                    AMapUI.load(['ui/misc/PointSimplifier', 'lib/$'], function (PointSimplifier, $) {
                        if (!PointSimplifier.supportCanvas) {
                            alert('当前环境不支持 Canvas！');
                            return;
                        }
                        if(pointSimplifierIns != null){
                            pointSimplifierIns.setData();  //设置为空，移除闪烁点
                        }
                        pointSimplifierIns = new PointSimplifier({
                            zIndex: 115,
                            autoSetFitView: false,
                            map: map, //所属的地图实例
                            getPosition: function (item) {
                                if (!item ) {
                                    return null;
                                }
                                return  item;
                            },
                            //使用GroupStyleRender
                            renderConstructor: PointSimplifier.Render.Canvas.GroupStyleRender,
                            renderOptions: {
                                eventSupport: false, //禁止事件,对性能更友好
                                //点的样式
                                pointStyle: {
                                    fillStyle: null,
                                    width: 5,
                                    height: 5
                                },
                                topNAreaStyle: null,
                                getGroupId: function (item, idx) {

                                    //随机返回一个组ID
                                    return Math.ceil(colors.length * Math.random());
                                },
                                groupStyleOptions: function (gid) {

                                    //随机设置大小
                                    var radius = 10 + 10 * Math.random();
                                    return {
                                        pointStyle: radius > 0 ? {
                                            content: function (ctx, x, y, width, height) {
                                                var p = {
                                                    x: x + width / 2,
                                                    y: y + height / 2,
                                                    radius: radius
                                                };
                                                ctx.beginPath();
                                                var gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.radius);
                                                gradient.addColorStop(0, "rgba(255,0,0,1)");
                                                gradient.addColorStop(1, "rgba(255,0,0,0.1)");
                                                ctx.fillStyle = gradient;
                                                ctx.arc(p.x, p.y, p.radius, Math.PI * 2, false);
                                                ctx.fill();
                                            },
                                            //fillStyle: colors[gid % colors.length],
                                            width: radius * 2,
                                            height: radius * 2
                                        } : null,
                                        pointHardcoreStyle: {
                                            width: radius * 2 + 3,
                                            height: radius * 2 + 3
                                        }
                                    };
                                }
                            }
                        });
                        //重复render  闪烁的频率
                        setInterval(function () {
                            pointSimplifierIns.render();
                        }, 500);
                        pointSimplifierIns.setData(new Array(posi));
                    });
                    map.panTo(posi);
                }

                //构建自定义信息窗体
                function createInfoWindow(title, content) {
                    var info = document.createElement("div");
                    info.className = "info";

                    //可以通过下面的方式修改自定义窗体的宽高
                    info.style.width = "240px";
                    // 定义顶部标题
                    var top = document.createElement("div");
                    var titleD = document.createElement("div");
                    var closeX = document.createElement("img");
                    top.className = "info-top";
                    titleD.innerHTML = title;
                    closeX.src = "res/i/close2.gif";
                    closeX.onclick = closeInfoWindow;

                    top.appendChild(titleD);
                    top.appendChild(closeX);
                    info.appendChild(top);

                    // 定义中部内容
                    var middle = document.createElement("div");
                    middle.className = "info-middle";
                    middle.style.backgroundColor = 'white';
                    middle.innerHTML = content;
                    info.appendChild(middle);
                    return info;
                }
                //关闭信息窗体
                function closeInfoWindow() {
                    map.clearInfoWindow();
                }
            </script>
        </div>
    </div>
    <!-- END PAGE CONTAINER-->
</div>

<!-- END PAGE -->
<script src="media/js/jquery-1.10.1.min.js" type="text/javascript"></script>
<script src="media/js/bootstrap.min.js" type="text/javascript"></script>
<script src="media/js/app.js" type="text/javascript"></script>
<script>
    jQuery(document).ready(function () {
        App.init();
    });

</script>
</body>
</html>